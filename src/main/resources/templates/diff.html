<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Comparison Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" rel="stylesheet"/>
</head>
<body>
<style>
    .file-tree-card {
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        display: flex;
        flex-direction: column;
    }

    .file-tree-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
    }

    .file-tree {
        flex: 1;
        overflow-y: auto;
    }

    .file-tree ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .file-tree-card .tree-children {
        padding-left: 1rem;
        margin-left: 0.5rem;
        margin-top: 0.25rem;
    }

    .tree-children.is-collapsed {
        display: none;
    }

    .tree-directory {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        margin-top: 0.5rem;
        background: transparent;
        border: 0;
        padding: 0;
        color: inherit;
        cursor: pointer;
    }

    .tree-directory:focus-visible {
        outline: 2px solid #0d6efd;
        outline-offset: 2px;
    }

    .tree-directory:disabled {
        opacity: 0.6;
        cursor: default;
    }

    .tree-toggle-icon {
        display: inline-block;
        font-size: 0.7rem;
        transition: transform 0.2s ease;
    }

    .tree-directory[aria-expanded="false"] .tree-toggle-icon {
        transform: rotate(-90deg);
    }

    .tree-file {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin-bottom: 0.25rem;
    }

    .tree-file .form-check-input {
        margin: 0;
        cursor: pointer;
    }

    .tree-file.active .tree-link {
        font-weight: 600;
    }

    .tree-link {
        text-decoration: none;
    }

    .tree-link:hover,
    .tree-link:focus {
        text-decoration: underline;
    }

    .tree-file .badge {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .diff-section {
        scroll-margin-top: 80px;
        padding-top: 0.5rem;
    }

    .diff-highlight {
        animation: diff-highlight 2s ease-out;
    }

    .diff-heading {
        margin: 0 0 1rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 1.5rem;
        font-weight: 600;
        border-left: 4px solid transparent;
    }

    .diff-heading.diff-heading-added {
        background-color: #d1e7dd;
        color: #0f5132;
        border-left-color: #198754;
    }

    .diff-heading.diff-heading-deleted {
        background-color: #f8d7da;
        color: #842029;
        border-left-color: #dc3545;
    }

    .diff-heading.diff-heading-modified {
        background-color: #cfe2ff;
        color: #052c65;
        border-left-color: #0d6efd;
    }

    .diff-heading.diff-heading-renamed {
        background-color: #fff3cd;
        color: #664d03;
        border-left-color: #ffc107;
    }

    .diff-heading.diff-heading-unchanged {
        background-color: #e2e3e5;
        color: #41464b;
        border-left-color: #6c757d;
    }

    @keyframes diff-highlight {
        from {
            background-color: #fff3cd;
        }
        to {
            background-color: transparent;
        }
    }
</style>
<div class="container-fluid mt-4">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <h1 class="mb-0" th:text="${message}">Comparison Result</h1>
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-primary" type="button" id="saveResultButton">Save Comparison</button>
            <a class="btn btn-outline-secondary" href="/">Return to Index</a>
        </div>
    </div>
    <div class="alert mt-3 d-none" id="saveStatus" role="alert"></div>
    <div class="row mt-3">
        <div class="col-lg-3 mb-3">
            <div class="card h-100 file-tree-card">
                <div class="card-header">Files</div>
                <div class="card-body">
                    <div class="file-tree" id="fileTree"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div id="timingSummary"></div>
            <div id="diffContent"></div>
        </div>
    </div>
    <a class="btn btn-secondary mt-3" href="/">New Comparison</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script th:inline="javascript">
    const result = [[${result}]];
    const diffContainer = document.getElementById('diffContent');
    const timingContainer = document.getElementById('timingSummary');
    const fileTreeContainer = document.getElementById('fileTree');
    const saveButton = document.getElementById('saveResultButton');
    const saveStatus = document.getElementById('saveStatus');
    const diffSections = new Map();
    let activeTreeItem = null;
    let directoryIdCounter = 0;

    function setStatus(message, type) {
        if (!saveStatus) {
            return;
        }
        saveStatus.textContent = message;
        saveStatus.className = `alert mt-3 alert-${type}`;
    }

    function clearStatus() {
        if (!saveStatus) {
            return;
        }
        saveStatus.textContent = '';
        saveStatus.className = 'alert mt-3 d-none';
    }

    const STATUS_INFO = {
        added: {label: 'Added', badgeClass: 'bg-success', headingClass: 'diff-heading-added'},
        deleted: {label: 'Deleted', badgeClass: 'bg-danger', headingClass: 'diff-heading-deleted'},
        modified: {label: 'Modified', badgeClass: 'bg-primary', headingClass: 'diff-heading-modified'},
        renamed: {label: 'Renamed', badgeClass: 'bg-warning text-dark', headingClass: 'diff-heading-renamed'},
        unchanged: {label: 'Unchanged', badgeClass: 'bg-secondary', headingClass: 'diff-heading-unchanged'},
    };

    function formatSeconds(value) {
        if (typeof value !== 'number' || Number.isNaN(value) || value < 0) {
            return 'â€”';
        }
        if (value >= 120) {
            const minutes = Math.floor(value / 60);
            const seconds = value - minutes * 60;
            const secondsText = seconds >= 10 ? seconds.toFixed(0) : seconds.toFixed(1);
            return `${minutes}m ${secondsText}s`;
        }
        if (value >= 10) {
            return `${value.toFixed(1)} s`;
        }
        if (value >= 1) {
            return `${value.toFixed(2)} s`;
        }
        if (value >= 0.001) {
            return `${(value * 1000).toFixed(1)} ms`;
        }
        return `${(value * 1000).toFixed(2)} ms`;
    }

    function renderTimingSummary(timing) {
        if (!timingContainer) {
            return;
        }
        timingContainer.innerHTML = '';
        if (!timing) {
            return;
        }

        const steps = Array.isArray(timing.steps) ? timing.steps : [];
        const hasTotal =
            typeof timing.totalDurationSeconds === 'number' && !Number.isNaN(timing.totalDurationSeconds);
        if (!hasTotal && steps.length === 0) {
            return;
        }

        const card = document.createElement('div');
        card.className = 'card mb-3';

        const header = document.createElement('div');
        header.className = 'card-header';
        header.textContent = 'Timing Summary';
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'card-body';

        if (hasTotal) {
            const total = document.createElement('p');
            total.className = 'card-text';
            total.innerHTML = `<strong>Total time:</strong> ${formatSeconds(timing.totalDurationSeconds)}`;
            body.appendChild(total);
        }

        if (steps.length > 0) {
            const table = document.createElement('table');
            table.className = 'table table-sm mb-0';
            const tbody = document.createElement('tbody');
            steps.forEach((step, index) => {
                const row = document.createElement('tr');

                const labelCell = document.createElement('th');
                labelCell.scope = 'row';
                labelCell.textContent = step.label || `Step ${index + 1}`;

                const valueCell = document.createElement('td');
                valueCell.className = 'text-end';
                valueCell.textContent = formatSeconds(step.durationSeconds);

                row.appendChild(labelCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            body.appendChild(table);
        }

        card.appendChild(body);
        timingContainer.appendChild(card);
    }

    function slugify(value) {
        return value
            .toString()
            .trim()
            .replace(/[\\/]+/g, '-')
            .replace(/[^a-zA-Z0-9-_]+/g, '-')
            .replace(/-{2,}/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    function renderDiff(item) {
        const container = document.createElement('div');
        container.id = item.id;
        container.className = 'diff-section mb-4';

        const statusInfo = STATUS_INFO[item.status] || STATUS_INFO.modified;

        const heading = document.createElement('h3');
        heading.textContent = item.title;
        heading.className = 'diff-heading';
        if (statusInfo.headingClass) {
            heading.classList.add(statusInfo.headingClass);
        }
        container.appendChild(heading);

        let toggleButton = null;
        let content = null;

        if (item.diff) {
            const html = Diff2Html.html(item.diff, {drawFileList: false, outputFormat: 'side-by-side'});
            const diffEl = document.createElement('div');
            diffEl.innerHTML = html;
            const header = diffEl.querySelector('.d2h-file-header');
            content = diffEl.querySelector('.d2h-files-diff');
            toggleButton = document.createElement('button');
            toggleButton.type = 'button';
            toggleButton.className = 'btn btn-link btn-sm diff-toggle';
            toggleButton.textContent = 'Show';
            toggleButton.addEventListener('click', () => {
                const hidden = content.style.display === 'none';
                content.style.display = hidden ? '' : 'none';
                toggleButton.textContent = hidden ? 'Hide' : 'Show';
            });
            header.appendChild(toggleButton);
            content.style.display = 'none';
            container.appendChild(diffEl);
        } else {
            const p = document.createElement('p');
            p.textContent = 'No changes';
            container.appendChild(p);
        }

        diffContainer.appendChild(container);
        diffSections.set(item.id, {container, toggleButton, content});
    }

    function buildTree(items) {
        const root = {name: '', children: new Map(), files: []};

        items.forEach((item) => {
            const normalizedPath = (item.sortName || '').replace(/\\/g, '/');
            const parts = normalizedPath.split('/').filter((p) => p);

            if (parts.length === 0) {
                root.files.push({name: item.sortName || item.title, item});
                return;
            }

            let node = root;
            for (let i = 0; i < parts.length - 1; i += 1) {
                const part = parts[i];
                if (!node.children.has(part)) {
                    node.children.set(part, {name: part, children: new Map(), files: []});
                }
                node = node.children.get(part);
            }

            const fileName = parts[parts.length - 1];
            node.files.push({name: fileName, item});
        });

        return root;
    }

    function createTreeList(node, isRoot = true, path = []) {
        const ul = document.createElement('ul');
        if (!isRoot) {
            ul.classList.add('tree-children');
        }

        const directories = Array.from(node.children.values()).sort((a, b) => a.name.localeCompare(b.name));
        directories.forEach((dir) => {
            const li = document.createElement('li');

            const toggleButton = document.createElement('button');
            toggleButton.type = 'button';
            toggleButton.className = 'tree-directory';
            toggleButton.setAttribute('aria-expanded', 'true');

            const icon = document.createElement('span');
            icon.className = 'tree-toggle-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.textContent = 'â–¾';
            toggleButton.appendChild(icon);

            const label = document.createElement('span');
            label.textContent = dir.name;
            toggleButton.appendChild(label);

            const childPath = [...path, dir.name];
            const hasChildren = (dir.children && dir.children.size > 0) || (dir.files && dir.files.length > 0);

            if (hasChildren) {
                const childList = createTreeList(dir, false, childPath);

                directoryIdCounter += 1;
                const directorySlug = slugify(childPath.join('/'));
                const directoryId = `tree-group-${directoryIdCounter}${directorySlug ? `-${directorySlug}` : ''}`;
                childList.id = directoryId;
                toggleButton.setAttribute('aria-controls', directoryId);

                toggleButton.addEventListener('click', () => {
                    const collapsed = childList.classList.toggle('is-collapsed');
                    toggleButton.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                });

                li.appendChild(toggleButton);
                li.appendChild(childList);
            } else {
                toggleButton.disabled = true;
                li.appendChild(toggleButton);
            }

            ul.appendChild(li);
        });

        const files = node.files.sort((a, b) => a.name.localeCompare(b.name));
        files.forEach((fileEntry) => {
            const {item} = fileEntry;
            const li = document.createElement('li');
            li.className = 'tree-file';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input tree-file-checkbox';
            checkbox.id = `${item.id}-checkbox`;
            checkbox.setAttribute('aria-label', `Select ${fileEntry.name}`);

            const link = document.createElement('a');
            link.href = `#${item.id}`;
            link.className = 'tree-link';
            link.textContent = fileEntry.name;
            if (item.status === 'renamed' && item.from) {
                link.title = `Renamed from ${item.from}`;
            }

            link.addEventListener('click', (event) => {
                event.preventDefault();
                if (activeTreeItem && activeTreeItem !== li) {
                    activeTreeItem.classList.remove('active');
                }
                li.classList.add('active');
                activeTreeItem = li;
                const target = document.getElementById(item.id);
                if (target) {
                    target.scrollIntoView({behavior: 'smooth', block: 'start'});
                    const info = diffSections.get(item.id);
                    if (info && info.content && info.content.style.display === 'none' && info.toggleButton) {
                        info.toggleButton.click();
                    }
                    if (info) {
                        info.container.classList.add('diff-highlight');
                        window.setTimeout(() => info.container.classList.remove('diff-highlight'), 2000);
                    }
                }
            });

            const statusInfo = STATUS_INFO[item.status] || STATUS_INFO.modified;
            const badge = document.createElement('span');
            badge.className = `badge ${statusInfo.badgeClass}`;
            badge.textContent = statusInfo.label;

            li.appendChild(checkbox);
            li.appendChild(link);
            li.appendChild(badge);
            ul.appendChild(li);
        });

        return ul;
    }

    function renderFileTree(items) {
        fileTreeContainer.innerHTML = '';
        if (items.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'text-muted mb-0';
            emptyState.textContent = 'No files to display.';
            fileTreeContainer.appendChild(emptyState);
            return;
        }

        const tree = buildTree(items);
        fileTreeContainer.appendChild(createTreeList(tree));
    }

    const diffs = [
        ...Object.entries(result.added || {}).map(([name, info]) => ({
            sortName: name,
            title: `Added ${name}`,
            diff: info.diff,
            status: 'added',
        })),
        ...Object.entries(result.deleted || {}).map(([name, info]) => ({
            sortName: name,
            title: `Deleted ${name}`,
            diff: info.diff,
            status: 'deleted',
        })),
        ...Object.entries(result.modified || {}).map(([name, info]) => ({
            sortName: name,
            title: `Modified ${name}`,
            diff: info.diff,
            status: 'modified',
        })),
        ...(result.renamed || []).map((r) => ({
            sortName: r.to,
            title: `Renamed ${r.from} -> ${r.to}`,
            diff: r.diff,
            status: 'renamed',
            from: r.from,
        })),
        ...(result.unchanged || []).map((name) => ({
            sortName: name,
            title: `Unchanged ${name}`,
            diff: null,
            status: 'unchanged',
        })),
    ];

    renderTimingSummary(result.timing);

    diffs.sort((a, b) => a.sortName.localeCompare(b.sortName));

    diffs.forEach((item, index) => {
        const slug = slugify(item.sortName || `item-${index}`) || `item-${index}`;
        item.id = `diff-${index}-${slug}`;
        renderDiff(item);
    });

    renderFileTree(diffs);

    async function saveComparison() {
        clearStatus();
        const comparisonName = window.prompt('Enter a name for this comparison:');
        if (!comparisonName || !comparisonName.trim()) {
            setStatus('Save cancelled: comparison name is required.', 'warning');
            return;
        }

        const userName = window.prompt('Enter your name:');
        if (!userName || !userName.trim()) {
            setStatus('Save cancelled: user is required.', 'warning');
            return;
        }

        if (saveButton) {
            saveButton.disabled = true;
        }

        try {
            const response = await fetch('/compare/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: comparisonName, user: userName, result}),
            });

            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                const errorMessage = payload.error || 'Failed to save comparison result.';
                setStatus(errorMessage, 'danger');
                return;
            }

            const identifier = payload.id ? ` (ID: ${payload.id})` : '';
            setStatus(`Comparison saved successfully${identifier}.`, 'success');
        } catch (error) {
            setStatus('Unexpected error while saving the comparison result.', 'danger');
        } finally {
            if (saveButton) {
                saveButton.disabled = false;
            }
        }
    }

    if (saveButton) {
        saveButton.addEventListener('click', saveComparison);
    }

    if (window.location.hash) {
        const treeLink = fileTreeContainer.querySelector(`a[href='${window.location.hash}']`);
        if (treeLink) {
            const treeItem = treeLink.closest('.tree-file');
            if (treeItem) {
                treeItem.classList.add('active');
                activeTreeItem = treeItem;
                treeItem.scrollIntoView({block: 'nearest'});
            }
        }
    }

    window.addEventListener('hashchange', () => {
        if (!window.location.hash) {
            return;
        }
        const hashLink = fileTreeContainer.querySelector(`a[href='${window.location.hash}']`);
        if (!hashLink) {
            return;
        }
        const hashItem = hashLink.closest('.tree-file');
        if (!hashItem) {
            return;
        }
        if (activeTreeItem && activeTreeItem !== hashItem) {
            activeTreeItem.classList.remove('active');
        }
        hashItem.classList.add('active');
        activeTreeItem = hashItem;
        hashItem.scrollIntoView({block: 'nearest'});
    });
</script>
</body>
</html>
