<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Comparison Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" rel="stylesheet"/>
</head>
<body>
<style>
    .file-tree-card {
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        display: flex;
        flex-direction: column;
    }

    .file-tree-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
    }

    .file-tree {
        flex: 1;
        overflow-y: auto;
    }

    .file-tree ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .file-tree-card .tree-children {
        padding-left: 1rem;
        margin-left: 0.5rem;
        margin-top: 0.25rem;
    }

    .tree-children.is-collapsed {
        display: none;
    }

    .tree-directory {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        margin-top: 0.5rem;
        background: transparent;
        border: 0;
        padding: 0;
        color: inherit;
        cursor: pointer;
    }

    .tree-directory:focus-visible {
        outline: 2px solid #0d6efd;
        outline-offset: 2px;
    }

    .tree-directory:disabled {
        opacity: 0.6;
        cursor: default;
    }

    .tree-toggle-icon {
        display: inline-block;
        font-size: 0.7rem;
        transition: transform 0.2s ease;
    }

    .tree-directory[aria-expanded="false"] .tree-toggle-icon {
        transform: rotate(-90deg);
    }

    .tree-file {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin-bottom: 0.25rem;
    }

    .tree-file .form-check-input {
        margin: 0;
        cursor: pointer;
    }

    .tree-file.active .tree-link {
        font-weight: 600;
    }

    .tree-link {
        text-decoration: none;
    }

    .tree-link:hover,
    .tree-link:focus {
        text-decoration: underline;
    }

    .tree-file .badge {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .diff-section {
        scroll-margin-top: 80px;
        padding-top: 0.5rem;
    }

    .diff-highlight {
        animation: diff-highlight 2s ease-out;
    }

    .diff-heading {
        margin: 0 0 1rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 1.5rem;
        font-weight: 600;
        border-left: 4px solid transparent;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .diff-heading .diff-heading-title {
        flex: 1;
    }

    .diff-heading .form-check-input {
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
    }

    .diff-heading.diff-heading-added {
        background-color: #d1e7dd;
        color: #0f5132;
        border-left-color: #198754;
    }

    .diff-heading.diff-heading-deleted {
        background-color: #f8d7da;
        color: #842029;
        border-left-color: #dc3545;
    }

    .diff-heading.diff-heading-modified {
        background-color: #cfe2ff;
        color: #052c65;
        border-left-color: #0d6efd;
    }

    .diff-heading.diff-heading-renamed {
        background-color: #fff3cd;
        color: #664d03;
        border-left-color: #ffc107;
    }

    .diff-heading.diff-heading-unchanged {
        background-color: #e2e3e5;
        color: #41464b;
        border-left-color: #6c757d;
    }

    .home-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: #0d6efd;
        text-decoration: none;
    }

    .home-link:hover,
    .home-link:focus {
        text-decoration: underline;
        color: #0a58ca;
    }

    .mark-color-preview {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        display: inline-block;
    }

    .d2h-file-side-diff {
        overflow-x: auto;
    }

    .go-to-top-button {
        position: fixed;
        right: 1.5rem;
        bottom: 1.5rem;
        z-index: 1050;
    }

    @keyframes diff-highlight {
        from {
            background-color: #fff3cd;
        }
        to {
            background-color: transparent;
        }
    }
</style>
<div
        class="container-fluid mt-4"
        th:with="displayColor=${markColor}, displayLabel=${markColorLabel}"
>
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
        <div>
            <a class="home-link mb-2" href="/">homepage</a>
            <p class="text-muted mb-1" th:if="${comparisonId != null}" th:text="'Comparison #' + ${comparisonId}">
                Comparison #
            </p>
            <h1 class="mb-0" th:text="${message}">Comparison Result</h1>
        </div>
        <div class="ms-auto text-end">
            <div class="text-muted" th:if="${created != null}" th:text="${#temporals.format(created, 'yyyy-MM-dd HH:mm:ss')}">
                2024-01-01 10:00:00
            </div>
            <div class="text-muted" th:if="${ipRequest != null}" th:text="'Request IP: ' + ${ipRequest}">
                Request IP: 127.0.0.1
            </div>
            <form
                    th:if="${canEditComparison}"
                    th:action="@{|/compare/${comparisonId}/edit|}"
                    method="post"
                    class="d-flex flex-wrap align-items-center gap-2 justify-content-end mt-2"
            >
                <label class="form-label mb-0" for="nameInput">Name</label>
                <input
                        class="form-control form-control-sm w-auto"
                        id="nameInput"
                        maxlength="255"
                        name="name"
                        required
                        th:value="${message}"
                        type="text"
                />
                <label class="form-label mb-0" for="markColorInput">Mark color</label>
                <span
                        class="mark-color-preview"
                        id="markColorPreview"
                        th:style="'background-color:' + ${displayColor}"
                ></span>
                <select
                        class="form-select form-select-sm w-auto"
                        id="markColorInput"
                        name="markColor"
                        required
                >
                    <option
                            th:each="option : ${markColorOptions}"
                            th:text="${option.label}"
                            th:value="${option.value}"
                            th:selected="${option.value == displayColor}"
                    >
                        Blue
                    </option>
                </select>
                <span class="text-muted small" id="markColorLabel" th:text="${displayLabel}">
                    Blue
                </span>
                <button class="btn btn-primary btn-sm" type="submit">Save changes</button>
            </form>
            <div
                    class="d-flex align-items-center gap-2 justify-content-end mt-2"
                    th:if="${!canEditComparison}"
            >
                <span class="text-muted">Mark color</span>
                <span class="mark-color-preview" th:style="'background-color:' + ${displayColor}"></span>
                <span class="text-muted small" th:text="${displayLabel}">Blue</span>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-lg-3 mb-3">
            <div class="card h-100 file-tree-card">
                <div class="card-header">Files</div>
                <div class="card-body">
                    <div class="file-tree" id="fileTree"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div id="timingSummary"></div>
            <div id="diffContent"></div>
        </div>
    </div>
    <a class="btn btn-secondary mt-3" href="/">New Comparison</a>
</div>
<button class="btn btn-primary go-to-top-button d-none" id="goToTopButton" type="button">Go to top</button>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script th:inline="javascript">
    const result = [[${result}]];
    const diffContainer = document.getElementById('diffContent');
    const timingContainer = document.getElementById('timingSummary');
    const fileTreeContainer = document.getElementById('fileTree');
    const diffSections = new Map();
    const checkboxRegistry = new Map();
    let activeTreeItem = null;
    let directoryIdCounter = 0;

    const markColorInput = document.getElementById('markColorInput');
    const markColorPreview = document.getElementById('markColorPreview');
    const markColorLabel = document.getElementById('markColorLabel');

    if (markColorInput && markColorPreview && markColorLabel) {
        const updateMarkColorDisplay = (value, label) => {
            if (!value) {
                return;
            }
            markColorPreview.style.backgroundColor = value;
            markColorLabel.textContent = label || value;
        };

        const selectedOption = markColorInput.options[markColorInput.selectedIndex];
        updateMarkColorDisplay(
                markColorInput.value,
                selectedOption ? selectedOption.textContent : markColorInput.value,
        );

        markColorInput.addEventListener('change', (event) => {
            const option = event.target.options[event.target.selectedIndex];
            updateMarkColorDisplay(event.target.value, option ? option.textContent : event.target.value);
        });
    }

    const STATUS_INFO = {
        added: {label: 'Added', badgeClass: 'bg-success', headingClass: 'diff-heading-added'},
        deleted: {label: 'Deleted', badgeClass: 'bg-danger', headingClass: 'diff-heading-deleted'},
        modified: {label: 'Modified', badgeClass: 'bg-primary', headingClass: 'diff-heading-modified'},
        renamed: {label: 'Renamed', badgeClass: 'bg-warning text-dark', headingClass: 'diff-heading-renamed'},
        unchanged: {label: 'Unchanged', badgeClass: 'bg-secondary', headingClass: 'diff-heading-unchanged'},
    };

    function formatSeconds(value) {
        if (typeof value !== 'number' || Number.isNaN(value) || value < 0) {
            return '—';
        }
        if (value >= 120) {
            const minutes = Math.floor(value / 60);
            const seconds = value - minutes * 60;
            const secondsText = seconds >= 10 ? seconds.toFixed(0) : seconds.toFixed(1);
            return `${minutes}m ${secondsText}s`;
        }
        if (value >= 10) {
            return `${value.toFixed(1)} s`;
        }
        if (value >= 1) {
            return `${value.toFixed(2)} s`;
        }
        if (value >= 0.001) {
            return `${(value * 1000).toFixed(1)} ms`;
        }
        return `${(value * 1000).toFixed(2)} ms`;
    }

    function renderTimingSummary(timing) {
        if (!timingContainer) {
            return;
        }
        timingContainer.innerHTML = '';
        if (!timing) {
            return;
        }

        const steps = Array.isArray(timing.steps) ? timing.steps : [];
        const hasTotal =
            typeof timing.totalDurationSeconds === 'number' && !Number.isNaN(timing.totalDurationSeconds);
        if (!hasTotal && steps.length === 0) {
            return;
        }

        const card = document.createElement('div');
        card.className = 'card mb-3';

        const header = document.createElement('div');
        header.className = 'card-header';
        header.textContent = 'Timing Summary';
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'card-body';

        if (hasTotal) {
            const total = document.createElement('p');
            total.className = 'card-text';
            total.innerHTML = `<strong>Total time:</strong> ${formatSeconds(timing.totalDurationSeconds)}`;
            body.appendChild(total);
        }

        if (steps.length > 0) {
            const table = document.createElement('table');
            table.className = 'table table-sm mb-0';
            const tbody = document.createElement('tbody');
            steps.forEach((step, index) => {
                const row = document.createElement('tr');

                const labelCell = document.createElement('th');
                labelCell.scope = 'row';
                labelCell.textContent = step.label || `Step ${index + 1}`;

                const valueCell = document.createElement('td');
                valueCell.className = 'text-end';
                valueCell.textContent = formatSeconds(step.durationSeconds);

                row.appendChild(labelCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            body.appendChild(table);
        }

        card.appendChild(body);
        timingContainer.appendChild(card);
    }

    function slugify(value) {
        return value
            .toString()
            .trim()
            .replace(/[\\/]+/g, '-')
            .replace(/[^a-zA-Z0-9-_]+/g, '-')
            .replace(/-{2,}/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    function registerCheckbox(itemId, type, checkbox) {
        if (!checkboxRegistry.has(itemId)) {
            checkboxRegistry.set(itemId, {});
        }
        const entry = checkboxRegistry.get(itemId);
        entry[type] = checkbox;

        const otherType = type === 'tree' ? 'diff' : 'tree';
        if (entry[otherType] && entry[otherType].checked !== checkbox.checked) {
            checkbox.checked = entry[otherType].checked;
        }
    }

    function syncCheckboxState(itemId, source, checked) {
        const entry = checkboxRegistry.get(itemId);
        if (!entry) {
            return;
        }
        if (source !== 'tree' && entry.tree && entry.tree.checked !== checked) {
            entry.tree.checked = checked;
        }
        if (source !== 'diff' && entry.diff && entry.diff.checked !== checked) {
            entry.diff.checked = checked;
        }
    }

    function renderDiff(item) {
        const container = document.createElement('div');
        container.id = item.id;
        container.className = 'diff-section mb-4';

        const statusInfo = STATUS_INFO[item.status] || STATUS_INFO.modified;

        const heading = document.createElement('h3');
        heading.className = 'diff-heading';
        if (statusInfo.headingClass) {
            heading.classList.add(statusInfo.headingClass);
        }

        const diffCheckbox = document.createElement('input');
        diffCheckbox.type = 'checkbox';
        diffCheckbox.className = 'form-check-input diff-heading-checkbox';
        diffCheckbox.id = `${item.id}-diff-checkbox`;
        diffCheckbox.setAttribute('aria-label', `Select ${item.title}`);
        heading.appendChild(diffCheckbox);

        const headingText = document.createElement('span');
        headingText.className = 'diff-heading-title';
        headingText.textContent = item.title;
        heading.appendChild(headingText);

        registerCheckbox(item.id, 'diff', diffCheckbox);
        diffCheckbox.addEventListener('change', () => {
            syncCheckboxState(item.id, 'diff', diffCheckbox.checked);
        });

        container.appendChild(heading);

        let toggleButton = null;
        let content = null;

        if (item.diff) {
            const html = Diff2Html.html(item.diff, {drawFileList: false, outputFormat: 'side-by-side'});
            const diffEl = document.createElement('div');
            diffEl.innerHTML = html;
            disableDiffSideScrollSync(diffEl);
            const header = diffEl.querySelector('.d2h-file-header');
            content = diffEl.querySelector('.d2h-files-diff');
            toggleButton = document.createElement('button');
            toggleButton.type = 'button';
            toggleButton.className = 'btn btn-link btn-sm diff-toggle';
            toggleButton.textContent = 'Show';
            toggleButton.addEventListener('click', () => {
                const hidden = content.style.display === 'none';
                content.style.display = hidden ? '' : 'none';
                toggleButton.textContent = hidden ? 'Hide' : 'Show';
            });
            header.appendChild(toggleButton);
            content.style.display = 'none';
            container.appendChild(diffEl);
        } else {
            const p = document.createElement('p');
            p.textContent = 'No changes';
            container.appendChild(p);
        }

        diffContainer.appendChild(container);
        diffSections.set(item.id, {container, toggleButton, content});
    }

    function buildTree(items) {
        const root = {name: '', children: new Map(), files: []};

        items.forEach((item) => {
            const normalizedPath = (item.sortName || '').replace(/\\/g, '/');
            const parts = normalizedPath.split('/').filter((p) => p);

            if (parts.length === 0) {
                root.files.push({name: item.sortName || item.title, item});
                return;
            }

            let node = root;
            for (let i = 0; i < parts.length - 1; i += 1) {
                const part = parts[i];
                if (!node.children.has(part)) {
                    node.children.set(part, {name: part, children: new Map(), files: []});
                }
                node = node.children.get(part);
            }

            const fileName = parts[parts.length - 1];
            node.files.push({name: fileName, item});
        });

        return root;
    }

    function createTreeList(node, isRoot = true, path = []) {
        const ul = document.createElement('ul');
        if (!isRoot) {
            ul.classList.add('tree-children');
        }

        const directories = Array.from(node.children.values()).sort((a, b) => a.name.localeCompare(b.name));
        directories.forEach((dir) => {
            const li = document.createElement('li');

            const toggleButton = document.createElement('button');
            toggleButton.type = 'button';
            toggleButton.className = 'tree-directory';
            toggleButton.setAttribute('aria-expanded', 'true');

            const icon = document.createElement('span');
            icon.className = 'tree-toggle-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.textContent = '▾';
            toggleButton.appendChild(icon);

            const label = document.createElement('span');
            label.textContent = dir.name;
            toggleButton.appendChild(label);

            const childPath = [...path, dir.name];
            const hasChildren = (dir.children && dir.children.size > 0) || (dir.files && dir.files.length > 0);

            if (hasChildren) {
                const childList = createTreeList(dir, false, childPath);

                directoryIdCounter += 1;
                const directorySlug = slugify(childPath.join('/'));
                const directoryId = `tree-group-${directoryIdCounter}${directorySlug ? `-${directorySlug}` : ''}`;
                childList.id = directoryId;
                toggleButton.setAttribute('aria-controls', directoryId);

                toggleButton.addEventListener('click', () => {
                    const collapsed = childList.classList.toggle('is-collapsed');
                    toggleButton.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                });

                li.appendChild(toggleButton);
                li.appendChild(childList);
            } else {
                toggleButton.disabled = true;
                li.appendChild(toggleButton);
            }

            ul.appendChild(li);
        });

        const files = node.files.sort((a, b) => a.name.localeCompare(b.name));
        files.forEach((fileEntry) => {
            const {item} = fileEntry;
            const li = document.createElement('li');
            li.className = 'tree-file';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input tree-file-checkbox';
            checkbox.id = `${item.id}-checkbox`;
            checkbox.setAttribute('aria-label', `Select ${fileEntry.name}`);

            registerCheckbox(item.id, 'tree', checkbox);
            checkbox.addEventListener('change', () => {
                syncCheckboxState(item.id, 'tree', checkbox.checked);
            });

            const link = document.createElement('a');
            link.href = `#${item.id}`;
            link.className = 'tree-link';
            link.textContent = fileEntry.name;
            if (item.status === 'renamed' && item.from) {
                link.title = `Renamed from ${item.from}`;
            }

            link.addEventListener('click', (event) => {
                event.preventDefault();
                if (activeTreeItem && activeTreeItem !== li) {
                    activeTreeItem.classList.remove('active');
                }
                li.classList.add('active');
                activeTreeItem = li;
                const target = document.getElementById(item.id);
                if (target) {
                    target.scrollIntoView({behavior: 'smooth', block: 'start'});
                    const info = diffSections.get(item.id);
                    if (info && info.content && info.content.style.display === 'none' && info.toggleButton) {
                        info.toggleButton.click();
                    }
                    if (info) {
                        info.container.classList.add('diff-highlight');
                        window.setTimeout(() => info.container.classList.remove('diff-highlight'), 2000);
                    }
                }
            });

            const statusInfo = STATUS_INFO[item.status] || STATUS_INFO.modified;
            const badge = document.createElement('span');
            badge.className = `badge ${statusInfo.badgeClass}`;
            badge.textContent = statusInfo.label;

            li.appendChild(checkbox);
            li.appendChild(link);
            li.appendChild(badge);
            ul.appendChild(li);
        });

        return ul;
    }

    function disableDiffSideScrollSync(container) {
        if (!container) {
            return;
        }
        const syncAttributes = [
            'data-synchscroll-group',
            'data-d2h-scroll-group',
            'data-d2h-synch-scroll-group',
        ];
        const selector = syncAttributes.map((attr) => `[${attr}]`).join(', ');
        if (!selector) {
            return;
        }
        container.querySelectorAll(selector).forEach((element) => {
            syncAttributes.forEach((attr) => {
                if (element.hasAttribute(attr)) {
                    element.removeAttribute(attr);
                }
            });
        });
    }

    function renderFileTree(items) {
        fileTreeContainer.innerHTML = '';
        if (items.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'text-muted mb-0';
            emptyState.textContent = 'No files to display.';
            fileTreeContainer.appendChild(emptyState);
            return;
        }

        const tree = buildTree(items);
        fileTreeContainer.appendChild(createTreeList(tree));
    }

    const diffs = [
        ...Object.entries(result.added || {}).map(([name, info]) => ({
            sortName: name,
            title: `Added ${name}`,
            diff: info.diff,
            status: 'added',
        })),
        ...Object.entries(result.deleted || {}).map(([name, info]) => ({
            sortName: name,
            title: `Deleted ${name}`,
            diff: info.diff,
            status: 'deleted',
        })),
        ...Object.entries(result.modified || {}).map(([name, info]) => ({
            sortName: name,
            title: `Modified ${name}`,
            diff: info.diff,
            status: 'modified',
        })),
        ...(result.renamed || []).map((r) => ({
            sortName: r.to,
            title: `Renamed ${r.from} -> ${r.to}`,
            diff: r.diff,
            status: 'renamed',
            from: r.from,
        })),
        ...(result.unchanged || []).map((name) => ({
            sortName: name,
            title: `Unchanged ${name}`,
            diff: null,
            status: 'unchanged',
        })),
    ];

    renderTimingSummary(result.timing);

    diffs.sort((a, b) => a.sortName.localeCompare(b.sortName));

    diffs.forEach((item, index) => {
        const slug = slugify(item.sortName || `item-${index}`) || `item-${index}`;
        item.id = `diff-${index}-${slug}`;
        renderDiff(item);
    });

    renderFileTree(diffs);

    if (window.location.hash) {
        const treeLink = fileTreeContainer.querySelector(`a[href='${window.location.hash}']`);
        if (treeLink) {
            const treeItem = treeLink.closest('.tree-file');
            if (treeItem) {
                treeItem.classList.add('active');
                activeTreeItem = treeItem;
                treeItem.scrollIntoView({block: 'nearest'});
            }
        }
    }

    window.addEventListener('hashchange', () => {
        if (!window.location.hash) {
            return;
        }
        const hashLink = fileTreeContainer.querySelector(`a[href='${window.location.hash}']`);
        if (!hashLink) {
            return;
        }
        const hashItem = hashLink.closest('.tree-file');
        if (!hashItem) {
            return;
        }
        if (activeTreeItem && activeTreeItem !== hashItem) {
            activeTreeItem.classList.remove('active');
        }
        hashItem.classList.add('active');
        activeTreeItem = hashItem;
        hashItem.scrollIntoView({block: 'nearest'});
    });

    const goToTopButton = document.getElementById('goToTopButton');
    if (goToTopButton) {
        const toggleGoToTopVisibility = () => {
            if (window.scrollY > 200) {
                goToTopButton.classList.remove('d-none');
            } else {
                goToTopButton.classList.add('d-none');
            }
        };

        goToTopButton.addEventListener('click', () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });

        toggleGoToTopVisibility();
        window.addEventListener('scroll', toggleGoToTopVisibility);
    }
</script>
</body>
</html>
