<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Comparison Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" rel="stylesheet"/>
</head>
<body>
<style>
    .file-tree {
        max-height: 70vh;
        overflow-y: auto;
    }

    .file-tree ul {
        list-style: none;
        padding-left: 0;
    }

    .file-tree ul ul {
        padding-left: 1rem;
    }

    .tree-directory {
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .tree-file {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin-bottom: 0.25rem;
    }

    .tree-link {
        text-decoration: none;
    }

    .tree-link:hover,
    .tree-link:focus {
        text-decoration: underline;
    }

    .tree-file .badge {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .diff-section {
        scroll-margin-top: 80px;
        padding-top: 0.5rem;
    }

    .diff-highlight {
        animation: diff-highlight 2s ease-out;
    }

    @keyframes diff-highlight {
        from {
            background-color: #fff3cd;
        }
        to {
            background-color: transparent;
        }
    }
</style>
<div class="container mt-4">
    <h1 th:text="${message}">Comparison Result</h1>
    <div class="row mt-3">
        <div class="col-lg-3 mb-3">
            <div class="card h-100">
                <div class="card-header">Files</div>
                <div class="card-body">
                    <div class="file-tree" id="fileTree"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div id="diffContent"></div>
        </div>
    </div>
    <a class="btn btn-secondary mt-3" href="/">New Comparison</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script th:inline="javascript">
    const result = [[${result}]];
    const diffContainer = document.getElementById('diffContent');
    const fileTreeContainer = document.getElementById('fileTree');
    const diffSections = new Map();

    const STATUS_INFO = {
        added: {label: 'Added', badgeClass: 'bg-success'},
        deleted: {label: 'Deleted', badgeClass: 'bg-danger'},
        modified: {label: 'Modified', badgeClass: 'bg-primary'},
        renamed: {label: 'Renamed', badgeClass: 'bg-warning text-dark'},
        unchanged: {label: 'Unchanged', badgeClass: 'bg-secondary'},
    };

    function slugify(value) {
        return value
            .toString()
            .trim()
            .replace(/[\\/]+/g, '-')
            .replace(/[^a-zA-Z0-9-_]+/g, '-')
            .replace(/-{2,}/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    function renderDiff(item) {
        const container = document.createElement('div');
        container.id = item.id;
        container.className = 'diff-section mb-4';

        const heading = document.createElement('h3');
        heading.textContent = item.title;
        container.appendChild(heading);

        let toggleButton = null;
        let content = null;

        if (item.diff) {
            const html = Diff2Html.html(item.diff, {drawFileList: false, outputFormat: 'side-by-side'});
            const diffEl = document.createElement('div');
            diffEl.innerHTML = html;
            const header = diffEl.querySelector('.d2h-file-header');
            content = diffEl.querySelector('.d2h-files-diff');
            toggleButton = document.createElement('button');
            toggleButton.type = 'button';
            toggleButton.className = 'btn btn-link btn-sm diff-toggle';
            toggleButton.textContent = 'Show';
            toggleButton.addEventListener('click', () => {
                const hidden = content.style.display === 'none';
                content.style.display = hidden ? '' : 'none';
                toggleButton.textContent = hidden ? 'Hide' : 'Show';
            });
            header.appendChild(toggleButton);
            content.style.display = 'none';
            container.appendChild(diffEl);
        } else {
            const p = document.createElement('p');
            p.textContent = 'No changes';
            container.appendChild(p);
        }

        diffContainer.appendChild(container);
        diffSections.set(item.id, {container, toggleButton, content});
    }

    function buildTree(items) {
        const root = {name: '', children: new Map(), files: []};

        items.forEach((item) => {
            const normalizedPath = (item.sortName || '').replace(/\\/g, '/');
            const parts = normalizedPath.split('/').filter((p) => p);

            if (parts.length === 0) {
                root.files.push({name: item.sortName || item.title, item});
                return;
            }

            let node = root;
            for (let i = 0; i < parts.length - 1; i += 1) {
                const part = parts[i];
                if (!node.children.has(part)) {
                    node.children.set(part, {name: part, children: new Map(), files: []});
                }
                node = node.children.get(part);
            }

            const fileName = parts[parts.length - 1];
            node.files.push({name: fileName, item});
        });

        return root;
    }

    function createTreeList(node, isRoot = true) {
        const ul = document.createElement('ul');
        ul.className = isRoot ? 'mb-0' : 'mb-0 ps-3';

        const directories = Array.from(node.children.values()).sort((a, b) => a.name.localeCompare(b.name));
        directories.forEach((dir) => {
            const li = document.createElement('li');
            const label = document.createElement('div');
            label.className = 'tree-directory';
            label.textContent = dir.name;
            li.appendChild(label);
            li.appendChild(createTreeList(dir, false));
            ul.appendChild(li);
        });

        const files = node.files.sort((a, b) => a.name.localeCompare(b.name));
        files.forEach((fileEntry) => {
            const {item} = fileEntry;
            const li = document.createElement('li');
            li.className = 'tree-file';

            const link = document.createElement('a');
            link.href = `#${item.id}`;
            link.className = 'tree-link';
            link.textContent = fileEntry.name;
            if (item.status === 'renamed' && item.from) {
                link.title = `Renamed from ${item.from}`;
            }

            link.addEventListener('click', (event) => {
                event.preventDefault();
                const target = document.getElementById(item.id);
                if (target) {
                    target.scrollIntoView({behavior: 'smooth', block: 'start'});
                    const info = diffSections.get(item.id);
                    if (info && info.content && info.content.style.display === 'none' && info.toggleButton) {
                        info.toggleButton.click();
                    }
                    if (info) {
                        info.container.classList.add('diff-highlight');
                        window.setTimeout(() => info.container.classList.remove('diff-highlight'), 2000);
                    }
                }
            });

            const statusInfo = STATUS_INFO[item.status] || STATUS_INFO.modified;
            const badge = document.createElement('span');
            badge.className = `badge ${statusInfo.badgeClass}`;
            badge.textContent = statusInfo.label;

            li.appendChild(link);
            li.appendChild(badge);
            ul.appendChild(li);
        });

        return ul;
    }

    function renderFileTree(items) {
        fileTreeContainer.innerHTML = '';
        if (items.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'text-muted mb-0';
            emptyState.textContent = 'No files to display.';
            fileTreeContainer.appendChild(emptyState);
            return;
        }

        const tree = buildTree(items);
        fileTreeContainer.appendChild(createTreeList(tree));
    }

    const diffs = [
        ...Object.entries(result.added || {}).map(([name, info]) => ({
            sortName: name,
            title: `Added ${name}`,
            diff: info.diff,
            status: 'added',
        })),
        ...Object.entries(result.deleted || {}).map(([name, info]) => ({
            sortName: name,
            title: `Deleted ${name}`,
            diff: info.diff,
            status: 'deleted',
        })),
        ...Object.entries(result.modified || {}).map(([name, info]) => ({
            sortName: name,
            title: `Modified ${name}`,
            diff: info.diff,
            status: 'modified',
        })),
        ...(result.renamed || []).map((r) => ({
            sortName: r.to,
            title: `Renamed ${r.from} -> ${r.to}`,
            diff: r.diff,
            status: 'renamed',
            from: r.from,
        })),
        ...(result.unchanged || []).map((name) => ({
            sortName: name,
            title: `Unchanged ${name}`,
            diff: null,
            status: 'unchanged',
        })),
    ];

    diffs.sort((a, b) => a.sortName.localeCompare(b.sortName));

    diffs.forEach((item, index) => {
        const slug = slugify(item.sortName || `item-${index}`) || `item-${index}`;
        item.id = `diff-${index}-${slug}`;
        renderDiff(item);
    });

    renderFileTree(diffs);
</script>
</body>
</html>
