<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Source Compare</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css"
            rel="stylesheet"
    />
    <style>
        .drop-zone {
            position: relative;
            border: 2px dashed #ced4da;
            border-radius: 0.375rem;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
        }

        .drop-zone.dragover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 th:text="${message}">Source Compare Initialized</h1>

    <div class="mt-4">
        <h2>Recent comparisons</h2>
        <div th:if="${#lists.isEmpty(recentComparisons)}">
            <p class="text-muted mb-0">No comparisons have been run yet.</p>
        </div>
        <ul class="list-group" th:if="${!#lists.isEmpty(recentComparisons)}">
            <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                    th:each="comparison : ${recentComparisons}"
            >
                <a th:href="@{|/compare/${comparison.id}|}" th:text="${comparison.name}">
                    Comparison name
                </a>
                <span
                        class="badge bg-secondary"
                        th:text="${#temporals.format(comparison.created, 'yyyy-MM-dd HH:mm')}"
                >
                    2024-01-01 00:00
                </span>
            </li>
        </ul>
    </div>

    <form
            action="/compare"
            class="mt-3"
            enctype="multipart/form-data"
            id="compareForm"
            method="post"
    >
        <input name="mode" type="hidden" value="CLASS_VS_CLASS"/>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label" for="leftZip">Left archives</label>
                <div class="drop-zone mb-2" id="leftDropZone">
                    <span class="drop-zone-text">Drag &amp; drop or click to select</span>
                    <input
                            accept=".zip"
                            id="leftZip"
                            name="leftZip"
                            multiple
                            required
                            style="display: none"
                            type="file"
                    />
                </div>
                <div class="form-text">
                    Upload the ZIP file representing the left side of the comparison.
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="rightZip">Right archives</label>
                <div class="drop-zone mb-2" id="rightDropZone">
                    <span class="drop-zone-text">Drag &amp; drop or click to select</span>
                    <input
                            accept=".zip"
                            id="rightZip"
                            name="rightZip"
                            multiple
                            required
                            style="display: none"
                            type="file"
                    />
                </div>
                <div class="form-text">
                    Upload the ZIP file representing the right side of the comparison.
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4 col-lg-3">
                <label class="form-label" for="contextSize">Context size</label>
                <input
                        class="form-control"
                        id="contextSize"
                        min="0"
                        name="contextSize"
                        type="number"
                        value="5"
                />
                <div class="form-text">Number of unchanged lines included around each diff hunk.</div>
            </div>
            <div class="col-md-8 col-lg-5 d-flex align-items-end mt-3 mt-md-0">
                <div>
                    <div class="form-check mb-0">
                        <input
                                class="form-check-input"
                                id="showUnchanged"
                                name="showUnchanged"
                                type="checkbox"
                                value="true"
                        />
                        <label class="form-check-label" for="showUnchanged">Show unchanged files</label>
                    </div>
                    <div class="form-text">Include unchanged files in the comparison results.</div>
                </div>
            </div>
        </div>
        <button class="btn btn-primary" type="submit">Compare</button>
    </form>

    <div class="alert alert-danger mt-3 d-none" id="message" role="alert"></div>

    <div class="text-center mt-4" id="loading" style="display: none">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                    aria-controls="tree"
                    aria-selected="true"
                    class="nav-link active"
                    data-bs-target="#tree"
                    data-bs-toggle="tab"
                    id="tree-tab"
                    role="tab"
                    type="button"
            >
                Files
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                    aria-controls="diff"
                    aria-selected="false"
                    class="nav-link"
                    data-bs-target="#diff"
                    data-bs-toggle="tab"
                    id="diff-tab"
                    role="tab"
                    type="button"
            >
                Diff
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div
                aria-labelledby="tree-tab"
                class="tab-pane fade show active"
                id="tree"
                role="tabpanel"
        >
            <input
                    class="form-control mt-3 mb-2"
                    id="fileFilter"
                    placeholder="Filter files"
                    type="text"
            />
            <ul class="list-group" id="fileTree"></ul>
        </div>
        <div
                aria-labelledby="diff-tab"
                class="tab-pane fade"
                id="diff"
                role="tabpanel"
        >
            <div class="mt-3" id="diffContent"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script>
    function setupDropZone(dropZoneId, inputId) {
        const dropZone = document.getElementById(dropZoneId);
        const input = document.getElementById(inputId);

        dropZone.addEventListener('click', () => input.click());

        input.addEventListener('change', () => {
            const text = dropZone.querySelector('.drop-zone-text');
            const {files} = input;
            if (files.length) {
                if (files.length === 1) {
                    text.textContent = files[0].name;
                } else {
                    text.textContent = `${files.length} files selected`;
                }
            } else {
                text.textContent = 'Drag & drop or click to select';
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        ['dragleave', 'dragend'].forEach((type) => {
            dropZone.addEventListener(type, () => dropZone.classList.remove('dragover'));
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupDropZone('leftDropZone', 'leftZip');
        setupDropZone('rightDropZone', 'rightZip');

        const form = document.getElementById('compareForm');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');

        if (form && loading) {
            form.addEventListener('submit', () => {
                if (message) {
                    message.classList.add('d-none');
                }
                loading.style.display = 'block';
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                }
            });
        }
    });
</script>
</body>
</html>

